<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keystone Underwriting Platform | Value-Add Multifamily</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for input fields for a cleaner look */
        .input-group { display: grid; grid-template-columns: 2fr 1fr; align-items: center; gap: 0.75rem; }
        .input-group label { font-size: 0.875rem; color: #4b5563; font-weight: 500; }
        .input-group input { 
            text-align: right; 
            font-size: 0.875rem; 
            padding: 0.5rem; 
            border-radius: 0.375rem; 
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            transition: all 0.2s ease-in-out;
        }
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Section headers */
        h3 { 
            font-size: 1rem; 
            font-weight: 700; 
            color: #111827;
            border-bottom: 1px solid #e5e7eb; 
            padding-bottom: 0.5rem; 
            margin-bottom: 1rem; 
            margin-top: 1.5rem; 
        }
        /* Print-specific styles for the export function */
        @media print {
            body {
                background-color: #fff !important;
            }
            .no-print {
                display: none !important;
            }
            .print-container {
                display: block !important;
                width: 100% !important;
                box-shadow: none !important;
                border: none !important;
            }
             .grid {
                display: block;
            }
            .print-break-after {
                break-after: page;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900">

    <div class="container mx-auto p-4 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center no-print">
            <div class="flex items-center justify-center gap-3 mb-2">
                 <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
                </svg>
                <h1 class="text-4xl font-extrabold tracking-tight text-gray-900">Keystone Underwriting Platform</h1>
            </div>
            <p class="text-lg text-gray-600">Institutional-grade analysis of a $50M multifamily value-add acquisition.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit no-print">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Deal Assumptions</h2>
                
                <h3>Acquisition & Property</h3>
                <div class="space-y-3">
                    <div class="input-group"><label>Purchase Price</label><input type="number" id="purchasePrice" value="50000000"></div>
                    <div class="input-group"><label>Closing Costs (% of Price)</label><input type="number" id="closingCosts" value="2.5"></div>
                    <div class="input-group"><label>Number of Units</label><input type="number" id="units" value="250"></div>
                    <div class="input-group"><label>Renovation Budget ($/Unit)</label><input type="number" id="renovationPerUnit" value="15000"></div>
                </div>

                <h3>Financing (Senior Debt)</h3>
                <div class="space-y-3">
                    <div class="input-group"><label>Loan-to-Cost (%)</label><input type="number" id="ltc" value="65"></div>
                    <div class="input-group"><label>Interest Rate (%)</label><input type="number" id="interestRate" value="6.0"></div>
                    <div class="input-group"><label>Amortization (Years)</label><input type="number" id="amortization" value="30"></div>
                    <div class="input-group"><label>Interest-Only Period (Months)</label><input type="number" id="ioPeriod" value="24"></div>
                    <div class="input-group"><label>Financing Fees (% of Loan)</label><input type="number" id="financingFees" value="1.0"></div>
                </div>

                <h3>Operations & Revenue</h3>
                <div class="space-y-3">
                    <div class="input-group"><label>Avg. Starting Rent ($/Mo)</label><input type="number" id="startRent" value="1500"></div>
                    <div class="input-group"><label>Market Rent Growth (%/Yr)</label><input type="number" id="rentGrowth" value="3.0"></div>
                    <div class="input-group"><label>General Vacancy (%)</label><input type="number" id="vacancy" value="5.0"></div>
                    <div class="input-group"><label>Operating Expense Ratio (%)</label><input type="number" id="opexRatio" value="40"></div>
                    <div class="input-group"><label>OpEx Growth (%/Yr)</label><input type="number" id="opexGrowth" value="2.5"></div>
                    <div class="input-group"><label>Stabilized CapEx ($/Unit/Yr)</label><input type="number" id="stabilizedCapex" value="250"></div>
                </div>

                <h3>Exit & Partnership</h3>
                <div class="space-y-3">
                    <div class="input-group"><label>Hold Period (Years)</label><input type="number" id="holdPeriod" value="5"></div>
                    <div class="input-group"><label>Exit Cap Rate (%)</label><input type="number" id="exitCap" value="5.25"></div>
                    <div class="input-group"><label>Cost of Sale (%)</label><input type="number" id="costOfSale" value="1.5"></div>
                    <div class="input-group"><label>LP Equity Share (%)</label><input type="number" id="lpShare" value="90"></div>
                    <div class="input-group"><label>Preferred Return (%)</label><input type="number" id="prefReturn" value="8.0"></div>
                    <div class="input-group"><label>Promote Split (% GP/LP)</label><input type="text" id="promoteSplit" value="20 / 80"></div>
                </div>

                <button id="calculateBtn" class="mt-8 w-full bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700 transition duration-300">Run Underwriting</button>
                <button onclick="window.print()" class="mt-4 w-full flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 font-semibold py-3 px-6 rounded-lg hover:bg-gray-100 transition duration-300">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.32 0c.662 0 1.18.568 1.12 1.227l-.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.32 0l-3.232-3.232m-3.232 0l-3.232 3.232M9 6l3 3m0 0l3-3m-3 3v6.75" /></svg>
                    Export Report
                </button>
            </div>

            <!-- Right Column: Outputs -->
            <div class="lg:col-span-2 space-y-8 print-container">
                 <!-- Executive Summary Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 print-break-after">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Executive Summary</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Project IRR</p>
                            <p id="summaryIRR" class="text-4xl font-extrabold text-emerald-600">0.0%</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Equity Multiple</p>
                            <p id="summaryMOIC" class="text-4xl font-extrabold text-emerald-600">0.00x</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Equity Req.</p>
                            <p id="summaryEquity" class="text-4xl font-extrabold text-gray-800">$0.0M</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Exit Value</p>
                            <p id="summaryExit" class="text-4xl font-extrabold text-gray-800">$0.0M</p>
                        </div>
                    </div>
                    <div class="mt-6 text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">
                        <p id="summaryNarrative">Generating investment summary...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Capital Stack Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Project Capitalization</h2>
                        <div class="space-y-2 text-sm">
                            <h4 class="font-semibold text-gray-600">Sources</h4>
                            <div class="flex justify-between"><p>Senior Debt</p><p id="sourceDebt" class="font-mono">$0.0M</p></div>
                            <div class="flex justify-between"><p>Sponsor Equity (GP)</p><p id="sourceGPEquity" class="font-mono">$0.0M</p></div>
                            <div class="flex justify-between"><p>Investor Equity (LP)</p><p id="sourceLPEquity" class="font-mono">$0.0M</p></div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold"><p>Total Sources</p><p id="sourceTotal" class="font-mono">$0.0M</p></div>
                        </div>
                        <div class="space-y-2 text-sm mt-4">
                            <h4 class="font-semibold text-gray-600">Uses</h4>
                            <div class="flex justify-between"><p>Purchase Price</p><p id="usePrice" class="font-mono">$0.0M</p></div>
                            <div class="flex justify-between"><p>Renovation Budget</p><p id="useReno" class="font-mono">$0.0M</p></div>
                            <div class="flex justify-between"><p>Closing Costs</p><p id="useClosing" class="font-mono">$0.0M</p></div>
                            <div class="flex justify-between"><p>Financing Fees</p><p id="useFinancing" class="font-mono">$0.0M</p></div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold"><p>Total Uses</p><p id="useTotal" class="font-mono">$0.0M</p></div>
                        </div>
                    </div>

                    <!-- Returns Summary Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Partnership Returns</h2>
                        <div class="grid grid-cols-2 gap-y-4 gap-x-2">
                            <div class="text-center p-2 rounded-lg bg-emerald-50">
                                <p class="text-xs font-bold text-emerald-800">LP IRR</p>
                                <p id="lpIRR" class="text-2xl font-bold text-emerald-700">0.0%</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-emerald-50">
                                <p class="text-xs font-bold text-emerald-800">GP IRR</p>
                                <p id="gpIRR" class="text-2xl font-bold text-emerald-700">0.0%</p>
                            </div>
                             <div class="text-center p-2 rounded-lg bg-gray-100">
                                <p class="text-xs font-bold text-gray-600">LP Multiple</p>
                                <p id="lpMOIC" class="text-2xl font-bold text-gray-800">0.00x</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-100">
                                <p class="text-xs font-bold text-gray-600">GP Multiple</p>
                                <p id="gpMOIC" class="text-2xl font-bold text-gray-800">0.00x</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Annual Pro Forma Cash Flow</h2>
                    <div class="overflow-x-auto text-xs">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-2 text-left font-semibold">Metric</th>
                                    <th class="py-2 px-2 text-right font-semibold">Yr 1</th>
                                    <th class="py-2 px-2 text-right font-semibold">Yr 2</th>
                                    <th class="py-2 px-2 text-right font-semibold">Yr 3</th>
                                    <th class="py-2 px-2 text-right font-semibold">Yr 4</th>
                                    <th class="py-2 px-2 text-right font-semibold">Yr 5</th>
                                </tr>
                            </thead>
                            <tbody id="proFormaTable" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Profit Distribution Waterfall</h2>
                    <canvas id="waterfallChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        const $ = (id) => document.getElementById(id);
        const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
        const formatMillions = (val) => `$${(val / 1000000).toFixed(1)}M`;
        const formatPercent = (val) => `${(val * 100).toFixed(1)}%`;
        const formatMulti = (val) => `${val.toFixed(2)}x`;
        let waterfallChart;

        // --- IRR SOLVER (Net Present Value) ---
        function npv(rate, cashFlows) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + rate, i);
            }
            return npv;
        }

        function calculateIRR(cashFlows, guess = 0.1) {
            const MAX_ITER = 100;
            const TOLERANCE = 1e-7;
            let low = -0.99, high = 1.0;

            // Ensure first cash flow is negative
            if (cashFlows[0] >= 0) { return 0; }
            
            let mid = guess;
            for (let i = 0; i < MAX_ITER; i++) {
                const npvMid = npv(mid, cashFlows);
                if (Math.abs(npvMid) < TOLERANCE) {
                    return mid;
                }
                if (npv(low, cashFlows) * npvMid < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
                mid = (low + high) / 2;
            }
            return mid; // return best guess
        }


        // --- MAIN CALCULATION ENGINE ---
        function calculateModel() {
            // --- 1. GATHER INPUTS ---
            const purchasePrice = parseFloat($('purchasePrice').value);
            const closingCostsPct = parseFloat($('closingCosts').value) / 100;
            const units = parseInt($('units').value);
            const renoPerUnit = parseFloat($('renovationPerUnit').value);
            const ltc = parseFloat($('ltc').value) / 100;
            const interestRate = parseFloat($('interestRate').value) / 100;
            const amortization = parseInt($('amortization').value);
            const ioPeriod = parseInt($('ioPeriod').value);
            const financingFeesPct = parseFloat($('financingFees').value) / 100;
            const startRent = parseFloat($('startRent').value);
            const rentGrowth = parseFloat($('rentGrowth').value) / 100;
            const vacancy = parseFloat($('vacancy').value) / 100;
            const opexRatio = parseFloat($('opexRatio').value) / 100;
            const opexGrowth = parseFloat($('opexGrowth').value) / 100;
            const stabilizedCapex = parseFloat($('stabilizedCapex').value);
            const holdPeriod = parseInt($('holdPeriod').value);
            const exitCap = parseFloat($('exitCap').value) / 100;
            const costOfSalePct = parseFloat($('costOfSale').value) / 100;
            const lpShare = parseFloat($('lpShare').value) / 100;
            const gpShare = 1 - lpShare;
            const prefReturn = parseFloat($('prefReturn').value) / 100;
            const [gpPromote, lpPromote] = $('promoteSplit').value.split('/').map(s => parseFloat(s.trim()) / 100);

            // --- 2. SOURCES & USES ---
            const closingCosts = purchasePrice * closingCostsPct;
            const renovationBudget = units * renoPerUnit;
            const totalUses = purchasePrice + renovationBudget + closingCosts;
            const loanAmount = totalUses * ltc;
            const financingFees = loanAmount * financingFeesPct;
            const totalProjectCost = totalUses + financingFees;
            const totalEquity = totalProjectCost - loanAmount;
            const lpEquity = totalEquity * lpShare;
            const gpEquity = totalEquity * gpShare;

            // --- 3. BUILD MONTHLY PRO FORMA ---
            let monthlyData = [];
            let currentLoanBalance = loanAmount;
            const monthlyInterestRate = interestRate / 12;
            const amortizationMonths = amortization * 12;
            const pmt = (loanAmount * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -amortizationMonths));
            
            for (let month = 1; month <= holdPeriod * 12; month++) {
                const year = Math.ceil(month / 12);
                const currentMonthRent = startRent * Math.pow(1 + rentGrowth, year - 1);
                
                const pgi = units * currentMonthRent;
                const vacLoss = pgi * vacancy;
                const egi = pgi - vacLoss;

                const baseOpex = pgi * opexRatio;
                const totalOpex = (baseOpex / 12) * Math.pow(1 + opexGrowth, year - 1);
                const noi = egi - totalOpex;
                const capex = (stabilizedCapex * units / 12);
                const unleveredCF = noi - capex;

                const interestPayment = currentLoanBalance * monthlyInterestRate;
                let principalPayment = 0;
                if (month > ioPeriod) {
                    principalPayment = pmt - interestPayment;
                }
                const debtService = interestPayment + principalPayment;
                const leveredCF = unleveredCF - debtService;
                
                currentLoanBalance -= principalPayment;
                monthlyData.push({ year, noi, unleveredCF, leveredCF, currentLoanBalance });
            }

            // --- 4. SUMMARIZE ANNUALLY & CALCULATE METRICS ---
            let annualData = [];
            for (let y = 1; y <= holdPeriod; y++) {
                const yearData = monthlyData.filter(d => d.year === y);
                const annualNOI = yearData.reduce((sum, d) => sum + d.noi, 0);
                const annualLeveredCF = yearData.reduce((sum, d) => sum + d.leveredCF, 0);
                const eoyLoanBalance = yearData[yearData.length - 1].currentLoanBalance;
                const ltv = eoyLoanBalance / purchasePrice;
                const debtYield = annualNOI / eoyLoanBalance;
                annualData.push({ year: y, noi: annualNOI, leveredCF: annualLeveredCF, debtYield, ltv });
            }

            // --- 5. EXIT CALCULATION ---
            const forwardNOI = annualData[holdPeriod - 1].noi * (1 + rentGrowth);
            const grossExitValue = forwardNOI / exitCap;
            const costOfSale = grossExitValue * costOfSalePct;
            const netExitValue = grossExitValue - costOfSale;
            const loanRepayment = currentLoanBalance;
            const netSaleProceeds = netExitValue - loanRepayment;

            // --- 6. PROPERTY-LEVEL RETURNS ---
            const propertyCashFlows = [-totalEquity, ...annualData.map(d => d.leveredCF)];
            propertyCashFlows[holdPeriod] += netSaleProceeds;
            const projectIRR = calculateIRR(propertyCashFlows);
            const projectMOIC = propertyCashFlows.slice(1).reduce((a, b) => a + b, 0) / totalEquity;

            // --- 7. PARTNERSHIP WATERFALL ---
            let lpPrefAccrued = 0;
            let lpReturnOfCapital = lpEquity;
            let gpReturnOfCapital = gpEquity;
            let lpCF = Array(holdPeriod).fill(0);
            let gpCF = Array(holdPeriod).fill(0);

            for (let y = 0; y < holdPeriod; y++) {
                let cfToDistribute = annualData[y].leveredCF;
                if (y === holdPeriod - 1) cfToDistribute += netSaleProceeds;

                // Accrue pref on contributed capital
                lpPrefAccrued += (lpEquity - (lpEquity - lpReturnOfCapital)) * prefReturn;

                // Tier 1: Return of Capital (Pro-Rata)
                let rocToDistribute = Math.min(cfToDistribute, lpReturnOfCapital + gpReturnOfCapital);
                let lpRocDist = rocToDistribute * (lpReturnOfCapital / (lpReturnOfCapital + gpReturnOfCapital) || 0);
                let gpRocDist = rocToDistribute * (gpReturnOfCapital / (lpReturnOfCapital + gpReturnOfCapital) || 0);
                lpReturnOfCapital -= lpRocDist;
                gpReturnOfCapital -= gpRocDist;
                lpCF[y] += lpRocDist;
                gpCF[y] += gpRocDist;
                cfToDistribute -= rocToDistribute;

                // Tier 2: Preferred Return to LP
                let prefDist = Math.min(cfToDistribute, lpPrefAccrued);
                lpCF[y] += prefDist;
                lpPrefAccrued -= prefDist;
                cfToDistribute -= prefDist;

                // Tier 3: Promote Split
                if (cfToDistribute > 0) {
                    lpCF[y] += cfToDistribute * lpPromote;
                    gpCF[y] += cfToDistribute * gpPromote;
                }
            }

            const lpTotalCF = [-lpEquity, ...lpCF];
            const lpIRR = calculateIRR(lpTotalCF);
            const lpMOIC = lpTotalCF.slice(1).reduce((a, b) => a + b, 0) / lpEquity;
            
            const gpTotalCF = [-gpEquity, ...gpCF];
            const gpIRR = calculateIRR(gpTotalCF);
            const gpMOIC = gpTotalCF.slice(1).reduce((a, b) => a + b, 0) / gpEquity;

            // --- 8. UI UPDATES ---
            // Executive Summary
            $('summaryIRR').textContent = formatPercent(projectIRR);
            $('summaryMOIC').textContent = formatMulti(projectMOIC);
            $('summaryEquity').textContent = formatMillions(totalEquity);
            $('summaryExit').textContent = formatMillions(grossExitValue);
            $('summaryNarrative').textContent = `This ${holdPeriod}-year investment in a ${units}-unit multifamily asset is projected to generate a ${formatPercent(projectIRR)} IRR and a ${formatMulti(projectMOIC)} equity multiple. The strategy involves acquiring the property for ${formatMillions(purchasePrice)} and investing ${formatMillions(renovationBudget)} in value-add renovations. The project is capitalized with ${formatMillions(loanAmount)} in senior debt and requires ${formatMillions(totalEquity)} of equity. At exit, the property is projected to sell for ${formatMillions(grossExitValue)}, based on a ${formatPercent(exitCap)} forward cap rate.`;

            // Returns Summary
            $('lpIRR').textContent = formatPercent(lpIRR);
            $('gpIRR').textContent = formatPercent(gpIRR);
            $('lpMOIC').textContent = formatMulti(lpMOIC);
            $('gpMOIC').textContent = formatMulti(gpMOIC);

            // Capital Stack
            $('sourceDebt').textContent = formatMillions(loanAmount);
            $('sourceGPEquity').textContent = formatMillions(gpEquity);
            $('sourceLPEquity').textContent = formatMillions(lpEquity);
            $('sourceTotal').textContent = formatMillions(totalProjectCost);
            $('usePrice').textContent = formatMillions(purchasePrice);
            $('useReno').textContent = formatMillions(renovationBudget);
            $('useClosing').textContent = formatMillions(closingCosts);
            $('useFinancing').textContent = formatMillions(financingFees);
            $('useTotal').textContent = formatMillions(totalProjectCost);

            // Pro Forma Table
            const proFormaRows = [
                { label: 'NOI', data: annualData.map(d => formatCurrency(d.noi)) },
                { label: 'Levered CF', data: annualData.map(d => formatCurrency(d.leveredCF)) },
                { label: 'Debt Yield', data: annualData.map(d => formatPercent(d.debtYield)) },
                { label: 'LTV', data: annualData.map(d => formatPercent(d.ltv)) }
            ];
            $('proFormaTable').innerHTML = proFormaRows.map(row => `<tr>
                <td class="py-2 px-2 font-semibold text-gray-700">${row.label}</td>
                ${row.data.map(d => `<td class="py-2 px-2 text-right font-mono text-gray-800">${d}</td>`).join('')}
            </tr>`).join('');

            // Waterfall Chart
            const profitToLP = lpTotalCF.slice(1).reduce((a, b) => a + b, 0) - lpEquity;
            const profitToGP = gpTotalCF.slice(1).reduce((a, b) => a + b, 0) - gpEquity;
            const ctx = $('waterfallChart').getContext('2d');
            if (waterfallChart) waterfallChart.destroy();
            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['LP (Investors) Profit', 'GP (Sponsor) Profit'],
                    datasets: [{
                        label: 'Profit Distribution',
                        data: [profitToLP, profitToGP],
                        backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)'],
                        borderColor: ['#3B82F6', '#10B981'],
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.raw) } } },
                    scales: { x: { ticks: { callback: (val) => formatCurrency(val) } } }
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        $('calculateBtn').addEventListener('click', calculateModel);
        window.addEventListener('load', calculateModel);
    </script>
</body>
</html>
